#!/usr/bin/env bash
module_meta(){ echo "snmp|1.0|low"; }

module_detect(){
  local facts="$1"
  source "$facts"
  [[ ",$OPEN_UDP," =~ ,161, ]] || [[ ",$OPEN_TCP," =~ ,161, ]]
}

module_run(){
  local facts="$1" out="$2" scans="$3"
  source "$facts"
  mkdir -p "$out"
  local logf="$out/snmp.log"
  : > "$logf"

  # Default community list (very small + safe). You can expand later.
  local comms=("public" "private" "manager")

  if command -v snmpwalk >/dev/null 2>&1; then
    for c in "${comms[@]}"; do
      run_cmd "snmpwalk_${c}" 90 "$logf" -- \
        "snmpwalk -v2c -c '$c' '$HOST' 1.3.6.1.2.1.1 2>/dev/null | head -n 80 || true"
    done
  else
    echo "[!] snmpwalk not found; skipping." >> "$logf"
  fi

  if command -v onesixtyone >/dev/null 2>&1; then
    printf "%s\n" "${comms[@]}" > "$out/community.txt"
    run_cmd "onesixtyone" 30 "$logf" -- "onesixtyone -c '$out/community.txt' '$HOST' || true"
  fi
}
